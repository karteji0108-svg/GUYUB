<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Agenda | GUYUB</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 overflow-y-auto">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-emerald-950/35"></div>
    <div class="absolute -top-32 -right-24 h-80 w-80 rounded-full bg-emerald-500/10 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-24 h-96 w-96 rounded-full bg-sky-500/10 blur-3xl"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/60 backdrop-blur-xl">
    <div class="mx-auto max-w-md px-5 py-4 flex items-center justify-between gap-3">
      <div>
        <div class="text-sm font-extrabold tracking-tight">Agenda</div>
        <div id="subText" class="text-[11px] text-slate-300/80">Memuat‚Ä¶</div>
      </div>
      <a href="/app/home.html" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">
        Home
      </a>
    </div>
  </header>

  <main class="mx-auto max-w-md px-5 pb-28 pt-5">
    <!-- Filter -->
    <section class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-4">
      <div class="text-xs font-bold text-slate-300/80">Filter organisasi</div>
      <div class="mt-3 grid grid-cols-4 gap-2 text-[11px]">
        <button class="filterBtn rounded-2xl bg-white/10 px-2 py-3 font-extrabold" data-org="all">Semua</button>
        <button class="filterBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-org="rt">RT</button>
        <button class="filterBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-org="pkk">PKK</button>
        <button class="filterBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-org="kt">KT</button>
      </div>

      <div class="mt-3 flex items-center gap-2">
        <input id="searchInput" type="text" placeholder="Cari kegiatan‚Ä¶"
          class="flex-1 rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />
        <button id="btnRefresh"
          class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-extrabold hover:bg-white/10">
          ‚Üª
        </button>
      </div>
    </section>

    <!-- List -->
    <section class="mt-5">
      <div id="list" class="space-y-3"></div>

      <div id="empty" class="hidden mt-6 rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 text-center">
        <div class="text-sm font-extrabold">Belum ada agenda</div>
        <div class="mt-1 text-xs text-slate-300/80">Nanti kalau admin sudah menambah event, akan muncul di sini.</div>
      </div>
    </section>
  </main>

  <!-- Modal Detail -->
  <div id="modal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-x-0 bottom-0 mx-auto max-w-md px-5 pb-5">
      <div class="rounded-3xl border border-white/10 bg-slate-950/80 backdrop-blur-xl p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="mOrg" class="text-[11px] text-slate-300/80">‚Äî</div>
            <div id="mTitle" class="mt-1 text-lg font-extrabold">‚Äî</div>
            <div id="mTime" class="mt-2 text-xs text-slate-300/80">‚Äî</div>
            <div id="mLoc" class="mt-1 text-xs text-slate-300/80">‚Äî</div>
          </div>
          <button id="btnClose" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">
            Tutup
          </button>
        </div>

        <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs font-bold text-slate-200">Deskripsi</div>
          <div id="mDesc" class="mt-2 text-sm text-slate-200/90 whitespace-pre-wrap">‚Äî</div>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <button id="btnJoin"
            class="rounded-2xl bg-white px-4 py-3 text-sm font-extrabold text-slate-950 disabled:opacity-60">
            Daftar Ikut
          </button>
          <button id="btnShare"
            class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-extrabold hover:bg-white/10">
            Salin Info
          </button>
        </div>

        <div id="mHint" class="mt-3 text-[11px] text-slate-400">
          Tombol ‚ÄúDaftar Ikut‚Äù akan menyimpan kamu sebagai peserta.
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 z-30">
    <div class="mx-auto max-w-md px-5 pb-5">
      <div class="rounded-3xl border border-white/10 bg-slate-950/60 backdrop-blur-xl p-2">
        <div class="grid grid-cols-5 gap-2 text-[11px]">
          <a class="rounded-2xl px-2 py-3 text-center text-slate-300/80 hover:bg-white/5" href="/app/home.html">Home</a>
          <a class="rounded-2xl bg-white/10 px-2 py-3 text-center font-extrabold" href="/app/agenda.html">Agenda</a>
          <a class="rounded-2xl px-2 py-3 text-center text-slate-300/80 hover:bg-white/5" href="/app/kas.html">Kas</a>
          <a class="rounded-2xl px-2 py-3 text-center text-slate-300/80 hover:bg-white/5" href="/app/aduan.html">Aduan</a>
          <a class="rounded-2xl px-2 py-3 text-center text-slate-300/80 hover:bg-white/5" href="/app/profil.html">Profil</a>
        </div>
      </div>
    </div>
  </nav>

  <script>
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const subText = document.getElementById("subText");
    const searchInput = document.getElementById("searchInput");

    const modal = document.getElementById("modal");
    const btnClose = document.getElementById("btnClose");
    const btnJoin = document.getElementById("btnJoin");
    const btnShare = document.getElementById("btnShare");

    const mOrg = document.getElementById("mOrg");
    const mTitle = document.getElementById("mTitle");
    const mTime = document.getElementById("mTime");
    const mLoc = document.getElementById("mLoc");
    const mDesc = document.getElementById("mDesc");
    const mHint = document.getElementById("mHint");

    let currentOrg = "all";
    let allEvents = [];
    let currentUser = null;
    let currentProfile = null;
    let selectedEvent = null;

    function fmtOrg(org) {
      if (org === "rt") return "RT";
      if (org === "pkk") return "PKK";
      if (org === "kt") return "Karang Taruna";
      return "Umum";
    }
    function fmtDate(ts) {
      try {
        const d = ts?.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString("id-ID", { weekday:"short", year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      } catch { return "-"; }
    }
    function escapeHtml(s="") {
      return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    function setFilterButtonActive(org) {
      document.querySelectorAll(".filterBtn").forEach(btn => {
        const isActive = btn.dataset.org === org;
        btn.className =
          "filterBtn rounded-2xl px-2 py-3 text-[11px] " +
          (isActive ? "bg-white/10 font-extrabold" : "text-slate-300/80 hover:bg-white/5");
      });
    }

    function applyFilterAndRender() {
      const q = searchInput.value.trim().toLowerCase();
      const filtered = allEvents
        .filter(ev => currentOrg === "all" ? true : ev.org === currentOrg)
        .filter(ev => {
          if (!q) return true;
          return (ev.title || "").toLowerCase().includes(q) || (ev.description || "").toLowerCase().includes(q) || (ev.location || "").toLowerCase().includes(q);
        });

      renderList(filtered);
    }

    function renderList(items) {
      listEl.innerHTML = "";
      emptyEl.classList.toggle("hidden", items.length !== 0);

      items.forEach(ev => {
        const start = fmtDate(ev.startAt);
        const end = ev.endAt ? fmtDate(ev.endAt) : null;

        const chip = `
          <span class="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] font-bold text-slate-100">
            ${fmtOrg(ev.org)}
          </span>
        `;

        const status = ev.status || "open";
        const statusChip = `
          <span class="inline-flex items-center rounded-full border border-white/10 bg-slate-950/30 px-3 py-1 text-[11px] font-bold text-slate-100">
            ${status.toUpperCase()}
          </span>
        `;

        const html = `
          <article class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-5">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">${chip}${statusChip}</div>
                <div class="mt-2 text-base font-extrabold tracking-tight">${escapeHtml(ev.title || "(Tanpa judul)")}</div>
                <div class="mt-2 text-xs text-slate-300/80">
                  üóìÔ∏è ${start}${end ? " ‚Äî " + end : ""}
                </div>
                <div class="mt-1 text-xs text-slate-300/80">
                  üìç ${escapeHtml(ev.location || "Lokasi belum diisi")}
                </div>
              </div>
              <button data-id="${ev.id}" class="btnDetail rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">
                Detail
              </button>
            </div>

            <div class="mt-3 text-sm text-slate-200/90 line-clamp-2">
              ${escapeHtml(ev.description || "‚Äî")}
            </div>
          </article>
        `;
        listEl.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll(".btnDetail").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.dataset.id));
      });

      subText.textContent = `${items.length} kegiatan ditampilkan`;
    }

    function openModal(eventId) {
      const ev = allEvents.find(x => x.id === eventId);
      if (!ev) return;
      selectedEvent = ev;

      mOrg.textContent = fmtOrg(ev.org);
      mTitle.textContent = ev.title || "(Tanpa judul)";
      mTime.textContent = `üóìÔ∏è ${fmtDate(ev.startAt)}${ev.endAt ? " ‚Äî " + fmtDate(ev.endAt) : ""}`;
      mLoc.textContent = `üìç ${ev.location || "Lokasi belum diisi"}`;
      mDesc.textContent = ev.description || "‚Äî";

      btnJoin.disabled = !currentUser || (ev.status && ev.status !== "open");
      mHint.textContent = (ev.status && ev.status !== "open")
        ? "Pendaftaran ditutup untuk kegiatan ini."
        : "Tombol ‚ÄúDaftar Ikut‚Äù akan menyimpan kamu sebagai peserta.";

      modal.classList.remove("hidden");
    }

    function closeModal() {
      modal.classList.add("hidden");
      selectedEvent = null;
    }

    btnClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    document.getElementById("btnRefresh").addEventListener("click", () => {
      // akan di-handle oleh Firebase loader (di bawah), trigger reload manual:
      window.__reloadEvents && window.__reloadEvents();
    });

    searchInput.addEventListener("input", applyFilterAndRender);

    document.querySelectorAll(".filterBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        currentOrg = btn.dataset.org;
        setFilterButtonActive(currentOrg);
        applyFilterAndRender();
      });
    });

    btnShare.addEventListener("click", async () => {
      if (!selectedEvent) return;
      const txt =
        `*${selectedEvent.title || "Kegiatan"}*\n` +
        `Org: ${fmtOrg(selectedEvent.org)}\n` +
        `Waktu: ${fmtDate(selectedEvent.startAt)}${selectedEvent.endAt ? " ‚Äî " + fmtDate(selectedEvent.endAt) : ""}\n` +
        `Lokasi: ${selectedEvent.location || "-"}\n` +
        `Deskripsi: ${selectedEvent.description || "-"}`;

      try {
        await navigator.clipboard.writeText(txt);
        btnShare.textContent = "Tersalin ‚úì";
        setTimeout(() => (btnShare.textContent = "Salin Info"), 900);
      } catch {
        // fallback
        alert("Gagal menyalin. Salin manual:\n\n" + txt);
      }
    });
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, limit, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚úÖ GANTI sesuai Firebase kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const ROUTES = {
      login: "/login.html",
      register: "/register.html"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function go(path) {
      window.location.replace(path);
    }

    async function loadEvents(neighborhoodId) {
      subText.textContent = "Memuat agenda‚Ä¶";
      // Query: event by neighborhoodId, order by startAt
      // Jika neighborhoodId kosong, ambil semua (mode demo)
      let q;
      if (neighborhoodId) {
        q = query(
          collection(db, "events"),
          where("neighborhoodId", "==", neighborhoodId),
          orderBy("startAt", "asc"),
          limit(50)
        );
      } else {
        q = query(collection(db, "events"), orderBy("startAt", "asc"), limit(50));
      }

      const snap = await getDocs(q);
      const items = [];
      snap.forEach(d => items.push({ id: d.id, ...d.data() }));

      // simpan global untuk render
      allEvents = items;
      applyFilterAndRender();
    }

    // expose reload
    window.__reloadEvents = async () => {
      if (!currentProfile) return;
      await loadEvents(currentProfile.neighborhoodId || null);
    };

    async function joinEvent(eventId) {
      if (!currentUser || !currentProfile) throw new Error("Belum login.");
      const participantRef = doc(db, "events", eventId, "participants", currentUser.uid);

      await setDoc(participantRef, {
        uid: currentUser.uid,
        name: currentProfile.name || "Warga",
        status: "registered",
        checkInAt: null,
        createdAt: serverTimestamp()
      }, { merge: true });
    }

    // Join button
    btnJoin.addEventListener("click", async () => {
      if (!selectedEvent) return;
      try {
        btnJoin.disabled = true;
        btnJoin.textContent = "Menyimpan‚Ä¶";
        await joinEvent(selectedEvent.id);
        btnJoin.textContent = "Terdaftar ‚úì";
        setTimeout(() => {
          btnJoin.textContent = "Daftar Ikut";
          btnJoin.disabled = false;
          closeModal();
        }, 900);
      } catch (e) {
        console.error(e);
        btnJoin.textContent = "Daftar Ikut";
        btnJoin.disabled = false;
        alert(e.message || "Gagal mendaftar.");
      }
    });

    // Guard + load profile + load events
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        go(ROUTES.login);
        return;
      }
      currentUser = user;

      const usnap = await getDoc(doc(db, "users", user.uid));
      if (!usnap.exists()) {
        go(ROUTES.register);
        return;
      }
      currentProfile = usnap.data();

      const neigh = currentProfile.neighborhoodId || null;
      subText.textContent = neigh ? `Lingkungan: ${neigh}` : "Mode demo (tanpa kode lingkungan)";

      // init filter button
      setFilterButtonActive("all");

      await loadEvents(neigh);
    });
  </script>
</body>
</html>
