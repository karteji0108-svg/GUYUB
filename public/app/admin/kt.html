<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Admin Karang Taruna | GUYUB</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 overflow-y-auto">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-cyan-950/25"></div>
    <div class="absolute -top-32 -right-24 h-80 w-80 rounded-full bg-cyan-500/10 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-24 h-96 w-96 rounded-full bg-emerald-500/10 blur-3xl"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/60 backdrop-blur-xl">
    <div class="mx-auto max-w-md px-5 py-4 flex items-center justify-between gap-3">
      <div>
        <div class="text-sm font-extrabold tracking-tight">Admin Karang Taruna</div>
        <div id="subText" class="text-[11px] text-slate-300/80">Memuat‚Ä¶</div>
      </div>
      <div class="flex items-center gap-2">
        <a href="/app/home.html" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">Home</a>
        <button id="btnReload" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">‚Üª</button>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="mx-auto max-w-md px-5 pt-4">
    <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-2">
      <div class="grid grid-cols-4 gap-2 text-[11px]">
        <button class="tabBtn rounded-2xl bg-white/10 px-2 py-3 font-extrabold" data-tab="agenda">Agenda</button>
        <button class="tabBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-tab="kas">Kas</button>
        <button class="tabBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-tab="aduan">Aduan</button>
        <button class="tabBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-tab="roles">Role</button>
      </div>
    </div>
  </div>

  <main class="mx-auto max-w-md px-5 pb-10 pt-5 space-y-5">
    <!-- AGENDA -->
    <section id="tab_agenda" class="space-y-4">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="text-sm font-extrabold">Buat Kegiatan Karang Taruna</div>
        <div class="mt-1 text-xs text-slate-300/80">Event KT tampil di Agenda warga.</div>

        <div id="evAlert" class="hidden mt-4 rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-xs text-slate-200"></div>

        <form id="evForm" class="mt-4 space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-300">Org</label>
              <select id="evOrg" class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20">
                <option value="kt" selected>Karang Taruna</option>
                <option value="rt">RT</option>
                <option value="pkk">PKK</option>
              </select>
              <div class="mt-2 text-[11px] text-slate-400">Default: KT</div>
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">Status</label>
              <select id="evStatus" class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20">
                <option value="open">open</option>
                <option value="closed">closed</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Judul</label>
            <input id="evTitle" type="text" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="contoh: Latihan futsal / Bakti sosial" />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Deskripsi</label>
            <textarea id="evDesc" rows="3"
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="Detail kegiatan‚Ä¶"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-300">Mulai</label>
              <input id="evStart" type="datetime-local" required
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">Selesai (opsional)</label>
              <input id="evEnd" type="datetime-local"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />
            </div>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Lokasi</label>
            <input id="evLoc" type="text"
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="contoh: Lapangan / Balai RW" />
          </div>

          <button id="btnEvSubmit" class="w-full rounded-2xl bg-white px-4 py-3 text-sm font-extrabold text-slate-950 disabled:opacity-60">
            Simpan Event
          </button>
        </form>
      </div>

      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="flex items-center justify-between">
          <div class="text-sm font-extrabold">Event Terbaru (Lingkungan)</div>
          <span class="text-[11px] text-slate-400">max 12</span>
        </div>
        <div id="evList" class="mt-4 space-y-3"></div>
        <div id="evEmpty" class="hidden mt-4 text-center text-xs text-slate-300/80">Belum ada event.</div>
      </div>
    </section>

    <!-- KAS -->
    <section id="tab_kas" class="hidden space-y-4">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="text-sm font-extrabold">Verifikasi Pembayaran Kas Karang Taruna (Pending)</div>
        <div class="mt-1 text-xs text-slate-300/80">Hanya transaksi org <b>kt</b> yang ditampilkan.</div>
        <div id="kasList" class="mt-4 space-y-3"></div>
        <div id="kasEmpty" class="hidden mt-4 text-center text-xs text-slate-300/80">Tidak ada transaksi pending.</div>
      </div>
    </section>

    <!-- ADUAN -->
    <section id="tab_aduan" class="hidden space-y-4">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="text-sm font-extrabold">Aduan (Lingkungan)</div>
        <div class="mt-1 text-xs text-slate-300/80">KT bisa bantu aksi lapangan (event gotong royong, dll).</div>

        <div class="mt-3 grid grid-cols-4 gap-2 text-[11px]">
          <button class="cBtn rounded-2xl bg-white/10 px-2 py-3 font-extrabold" data-status="all">Semua</button>
          <button class="cBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-status="received">Diterima</button>
          <button class="cBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-status="in_progress">Proses</button>
          <button class="cBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-status="done">Selesai</button>
        </div>

        <input id="cSearch" type="text" placeholder="Cari aduan‚Ä¶"
          class="mt-3 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />

        <div id="complaintList" class="mt-4 space-y-3"></div>
        <div id="complaintEmpty" class="hidden mt-4 text-center text-xs text-slate-300/80">Belum ada aduan.</div>
      </div>
    </section>

    <!-- ROLES -->
    <section id="tab_roles" class="hidden space-y-4">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="text-sm font-extrabold">Verifikasi Role Request (KT)</div>
        <div class="mt-1 text-xs text-slate-300/80">Menampilkan request yang role-nya diawali <b>kt_</b>.</div>
        <div id="roleList" class="mt-4 space-y-3"></div>
        <div id="roleEmpty" class="hidden mt-4 text-center text-xs text-slate-300/80">Tidak ada role request pending.</div>
      </div>
    </section>
  </main>

  <!-- Modal: Update Aduan -->
  <div id="modalComplaint" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-x-0 bottom-0 mx-auto max-w-md px-5 pb-5">
      <div class="rounded-3xl border border-white/10 bg-slate-950/80 backdrop-blur-xl p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="mCTitle" class="text-lg font-extrabold">‚Äî</div>
            <div id="mCMeta" class="mt-1 text-xs text-slate-300/80">‚Äî</div>
          </div>
          <button id="btnCloseC" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">
            Tutup
          </button>
        </div>

        <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs font-bold text-slate-200">Detail</div>
          <div id="mCDetail" class="mt-2 text-sm text-slate-200/90 whitespace-pre-wrap">‚Äî</div>
          <div id="mCLoc" class="mt-3 text-xs text-slate-300/80">üìç ‚Äî</div>
          <a id="mCPhoto" class="hidden mt-3 inline-block text-xs font-bold text-white/90 hover:underline" target="_blank" rel="noreferrer">Lihat Foto</a>
        </div>

        <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-4">
          <div class="text-xs font-bold text-slate-200">Ubah Status</div>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <button class="btnCStatus rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-sm font-extrabold hover:bg-white/10" data-status="received">Diterima</button>
            <button class="btnCStatus rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-sm font-extrabold hover:bg-white/10" data-status="in_progress">Diproses</button>
            <button class="btnCStatus rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-sm font-extrabold hover:bg-white/10" data-status="done">Selesai</button>
            <button class="btnCStatus rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-sm font-extrabold hover:bg-white/10" data-status="rejected">Ditolak</button>
          </div>
          <input id="mCNote" type="text"
            class="mt-3 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
            placeholder="Catatan (opsional)" />
          <div id="mCAlert" class="hidden mt-3 rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-xs text-slate-200"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tabs
    const tabBtns = document.querySelectorAll(".tabBtn");
    const tabs = {
      agenda: document.getElementById("tab_agenda"),
      kas: document.getElementById("tab_kas"),
      aduan: document.getElementById("tab_aduan"),
      roles: document.getElementById("tab_roles"),
    };
    function setTab(name){
      tabBtns.forEach(b=>{
        const a = b.dataset.tab === name;
        b.className = "tabBtn rounded-2xl px-2 py-3 text-[11px] " + (a ? "bg-white/10 font-extrabold" : "text-slate-300/80 hover:bg-white/5");
      });
      Object.entries(tabs).forEach(([k, el])=> el.classList.toggle("hidden", k !== name));
    }
    tabBtns.forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));
    setTab("agenda");

    // helpers
    const subText = document.getElementById("subText");
    const btnReload = document.getElementById("btnReload");

    function fmtDate(ts) {
      try { const d = ts?.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString("id-ID",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}); }
      catch { return "‚Äî"; }
    }
    function fmtRp(n){ return "Rp " + Number(n||0).toLocaleString("id-ID"); }
    function esc(s=""){ return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

    // Agenda UI
    const evAlert = document.getElementById("evAlert");
    const evList = document.getElementById("evList");
    const evEmpty = document.getElementById("evEmpty");
    const btnEvSubmit = document.getElementById("btnEvSubmit");
    function showEvAlert(msg){ evAlert.textContent = msg; evAlert.classList.remove("hidden"); }
    function hideEvAlert(){ evAlert.classList.add("hidden"); evAlert.textContent=""; }

    // Kas UI
    const kasList = document.getElementById("kasList");
    const kasEmpty = document.getElementById("kasEmpty");

    // Complaints UI
    const complaintList = document.getElementById("complaintList");
    const complaintEmpty = document.getElementById("complaintEmpty");
    const cSearch = document.getElementById("cSearch");
    let cFilter = "all";

    // Role UI
    const roleList = document.getElementById("roleList");
    const roleEmpty = document.getElementById("roleEmpty");

    // Complaint modal
    const modalComplaint = document.getElementById("modalComplaint");
    const btnCloseC = document.getElementById("btnCloseC");
    const mCTitle = document.getElementById("mCTitle");
    const mCMeta = document.getElementById("mCMeta");
    const mCDetail = document.getElementById("mCDetail");
    const mCLoc = document.getElementById("mCLoc");
    const mCPhoto = document.getElementById("mCPhoto");
    const mCNote = document.getElementById("mCNote");
    const mCAlert = document.getElementById("mCAlert");
    function showCAlert(msg){ mCAlert.textContent=msg; mCAlert.classList.remove("hidden"); }
    function hideCAlert(){ mCAlert.classList.add("hidden"); mCAlert.textContent=""; }
    function openCModal(){ modalComplaint.classList.remove("hidden"); }
    function closeCModal(){ modalComplaint.classList.add("hidden"); hideCAlert(); mCNote.value=""; }
    btnCloseC.addEventListener("click", closeCModal);
    modalComplaint.addEventListener("click", (e)=>{ if(e.target===modalComplaint) closeCModal(); });

    // complaint filter
    document.querySelectorAll(".cBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        cFilter = btn.dataset.status;
        document.querySelectorAll(".cBtn").forEach(b=>{
          const a = b.dataset.status === cFilter;
          b.className = "cBtn rounded-2xl px-2 py-3 text-[11px] " + (a ? "bg-white/10 font-extrabold" : "text-slate-300/80 hover:bg-white/5");
        });
        window.__renderComplaints && window.__renderComplaints();
      });
    });
    cSearch.addEventListener("input", ()=> window.__renderComplaints && window.__renderComplaints());

    btnReload.addEventListener("click", ()=> window.__reloadAdmin && window.__reloadAdmin());
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc,
      collection, query, where, orderBy, limit, getDocs,
      addDoc, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚úÖ GANTI sesuai Firebase kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const ROUTES = {
      home: "/app/home.html",
      login: "/login.html",
      register: "/register.html"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let profile = null;
    let neighborhoodId = null;

    // caches
    let cacheEvents = [];
    let cachePendingTx = [];
    let cacheComplaints = [];
    let cacheRoleReq = [];
    let selectedComplaint = null;

    function go(path){ window.location.replace(path); }

    function isAllowed(role){
      return (role || "").startsWith("kt_") || role === "super_admin";
    }
    function isSuper(role){ return role === "super_admin"; }

    function walletDocId(neigh, org){ return `${neigh}_${org}`; }

    async function guardAndLoad(user){
      currentUser = user;
      const usnap = await getDoc(doc(db, "users", user.uid));
      if (!usnap.exists()) { go(ROUTES.register); return false; }

      profile = usnap.data();
      if (!isAllowed(profile.role || "")) { go(ROUTES.home); return false; }

      neighborhoodId = profile.neighborhoodId || null;
      subText.textContent = neighborhoodId ? `Lingkungan: ${neighborhoodId} ‚Ä¢ Role: ${profile.role}` : `Role: ${profile.role} (neighborhoodId belum diatur)`;
      return true;
    }

    // ===== AGENDA =====
    function renderEvents(){
      evList.innerHTML = "";
      evEmpty.classList.toggle("hidden", cacheEvents.length !== 0);

      cacheEvents.forEach(ev=>{
        const html = `
          <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
            <div class="min-w-0">
              <div class="text-[11px] text-slate-300/80">${esc(ev.org || "-").toUpperCase()} ‚Ä¢ ${esc(ev.status || "open")}</div>
              <div class="mt-1 text-sm font-extrabold">${esc(ev.title || "Event")}</div>
              <div class="mt-2 text-[11px] text-slate-300/80">üóìÔ∏è ${fmtDate(ev.startAt)}${ev.endAt ? " ‚Äî " + fmtDate(ev.endAt) : ""}</div>
              <div class="mt-1 text-[11px] text-slate-300/80">üìç ${esc(ev.location || "-")}</div>
            </div>
          </div>
        `;
        evList.insertAdjacentHTML("beforeend", html);
      });
    }

    async function loadEvents(){
      if (!neighborhoodId) { cacheEvents = []; renderEvents(); return; }

      const qs = query(
        collection(db, "events"),
        where("neighborhoodId", "==", neighborhoodId),
        orderBy("startAt", "desc"),
        limit(12)
      );
      const snap = await getDocs(qs);
      const items = [];
      snap.forEach(d=> items.push({ id:d.id, ...d.data() }));
      cacheEvents = items;
      renderEvents();
    }

    document.getElementById("evForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideEvAlert();
      if (!neighborhoodId) return showEvAlert("neighborhoodId belum diatur. Isi dulu di Profil.");

      const org = document.getElementById("evOrg").value || "kt";
      const status = document.getElementById("evStatus").value;
      const title = document.getElementById("evTitle").value.trim();
      const description = document.getElementById("evDesc").value.trim();
      const startRaw = document.getElementById("evStart").value;
      const endRaw = document.getElementById("evEnd").value;
      const location = document.getElementById("evLoc").value.trim();

      if (!isSuper(profile.role || "") && org !== "kt") return showEvAlert("Akses KT hanya untuk membuat event Karang Taruna.");

      if (!title) return showEvAlert("Judul wajib diisi.");
      if (!startRaw) return showEvAlert("Tanggal mulai wajib diisi.");

      try{
        btnEvSubmit.disabled = true;
        btnEvSubmit.textContent = "Menyimpan‚Ä¶";

        const startAt = new Date(startRaw);
        const endAt = endRaw ? new Date(endRaw) : null;

        await addDoc(collection(db, "events"), {
          neighborhoodId,
          org,
          status,
          title,
          description,
          startAt,
          endAt,
          location,
          createdBy: currentUser.uid,
          createdAt: serverTimestamp()
        });

        btnEvSubmit.disabled = false;
        btnEvSubmit.textContent = "Simpan Event";
        showEvAlert("Event tersimpan ‚úì");

        document.getElementById("evTitle").value = "";
        document.getElementById("evDesc").value = "";
        document.getElementById("evLoc").value = "";
        document.getElementById("evEnd").value = "";

        await loadEvents();
      }catch(err){
        console.error(err);
        btnEvSubmit.disabled = false;
        btnEvSubmit.textContent = "Simpan Event";
        showEvAlert("Gagal simpan event. Cek Firestore Rules.");
      }
    });

    // ===== KAS (pending org=kt) =====
    function renderKas(){
      kasList.innerHTML = "";
      kasEmpty.classList.toggle("hidden", cachePendingTx.length !== 0);

      cachePendingTx.forEach(t=>{
        const proof = t.proofUrl
          ? `<a class="text-[11px] font-bold text-white/90 hover:underline" target="_blank" rel="noreferrer" href="${esc(t.proofUrl)}">Lihat Bukti</a>`
          : `<span class="text-[11px] text-slate-400">Tanpa bukti</span>`;

        const html = `
          <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-extrabold">${esc(t.title || "Pembayaran")}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">KT ‚Ä¢ ${esc(t.category || "-")} ‚Ä¢ ${fmtDate(t.createdAt)}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">oleh: ${esc(t.createdBy || "-")}</div>
                <div class="mt-2">${proof}</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-extrabold">+ ${fmtRp(t.amount || 0)}</div>
                <div class="mt-3 grid grid-cols-2 gap-2">
                  <button class="btnApprove rounded-2xl bg-white px-3 py-2 text-xs font-extrabold text-slate-950" data-id="${t.id}">Approve</button>
                  <button class="btnReject rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-extrabold hover:bg-white/10" data-id="${t.id}">Reject</button>
                </div>
              </div>
            </div>
          </div>
        `;
        kasList.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll(".btnApprove").forEach(b=> b.addEventListener("click", ()=>approveTx(b.dataset.id)));
      document.querySelectorAll(".btnReject").forEach(b=> b.addEventListener("click", ()=>rejectTx(b.dataset.id)));
    }

    async function loadPendingTx(){
      if (!neighborhoodId) { cachePendingTx=[]; renderKas(); return; }

      const qs = query(
        collection(db, "finance_tx"),
        where("neighborhoodId", "==", neighborhoodId),
        where("org", "==", "kt"),
        where("approval.status", "==", "pending"),
        orderBy("createdAt", "desc"),
        limit(20)
      );
      const snap = await getDocs(qs);
      const items = [];
      snap.forEach(d=> items.push({ id:d.id, ...d.data() }));
      cachePendingTx = items;
      renderKas();
    }

    async function approveTx(txId){
      const t = cachePendingTx.find(x=>x.id===txId);
      if (!t) return;

      if (!confirm(`Approve transaksi "${t.title}" sebesar ${fmtRp(t.amount)}?`)) return;

      try{
        await updateDoc(doc(db, "finance_tx", txId), {
          "approval.status": "approved",
          "approval.by": currentUser.uid,
          "approval.at": serverTimestamp(),
          "approval.reason": ""
        });

        const wid = walletDocId(neighborhoodId, "kt");
        await setDoc(doc(db, "org_wallets", wid), {
          neighborhoodId,
          org: "kt",
          balance: increment(Number(t.amount || 0)),
          updatedAt: serverTimestamp()
        }, { merge: true });

        await loadPendingTx();
      }catch(err){
        console.error(err);
        alert("Gagal approve. Cek Firestore Rules.");
      }
    }

    async function rejectTx(txId){
      const reason = prompt("Alasan reject (opsional):") || "";
      try{
        await updateDoc(doc(db, "finance_tx", txId), {
          "approval.status": "rejected",
          "approval.by": currentUser.uid,
          "approval.at": serverTimestamp(),
          "approval.reason": reason
        });
        await loadPendingTx();
      }catch(err){
        console.error(err);
        alert("Gagal reject. Cek Firestore Rules.");
      }
    }

    // ===== COMPLAINTS =====
    window.__renderComplaints = function(){
      const q = (cSearch.value || "").trim().toLowerCase();
      const filtered = cacheComplaints
        .filter(c => cFilter === "all" ? true : (c.status || "received") === cFilter)
        .filter(c => {
          if (!q) return true;
          return (c.title || "").toLowerCase().includes(q) ||
                 (c.detail || "").toLowerCase().includes(q) ||
                 (c.location?.text || "").toLowerCase().includes(q);
        });

      complaintList.innerHTML = "";
      complaintEmpty.classList.toggle("hidden", filtered.length !== 0);

      filtered.forEach(c=>{
        const html = `
          <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-[11px] text-slate-300/80">${esc(c.category || "-")} ‚Ä¢ ${fmtDate(c.createdAt)}</div>
                <div class="mt-1 text-sm font-extrabold">${esc(c.title || "Aduan")}</div>
                <div class="mt-2 text-[11px] text-slate-300/80">üìç ${esc(c.location?.text || "-")}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">Status: <b>${esc((c.status || "received").toUpperCase())}</b></div>
              </div>
              <button class="btnOpenComplaint rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10"
                data-id="${c.id}">
                Detail
              </button>
            </div>
          </div>
        `;
        complaintList.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll(".btnOpenComplaint").forEach(b=>{
        b.addEventListener("click", ()=>openComplaint(b.dataset.id));
      });
    }

    async function loadComplaints(){
      if (!neighborhoodId) { cacheComplaints=[]; window.__renderComplaints(); return; }
      const qs = query(
        collection(db, "complaints"),
        where("neighborhoodId", "==", neighborhoodId),
        orderBy("createdAt", "desc"),
        limit(50)
      );
      const snap = await getDocs(qs);
      const items = [];
      snap.forEach(d=> items.push({ id:d.id, ...d.data() }));
      cacheComplaints = items;
      window.__renderComplaints();
    }

    function openComplaint(id){
      const c = cacheComplaints.find(x=>x.id===id);
      if (!c) return;
      selectedComplaint = c;

      mCTitle.textContent = c.title || "Aduan";
      mCMeta.textContent = `${(c.status || "received").toUpperCase()} ‚Ä¢ ${fmtDate(c.createdAt)} ‚Ä¢ oleh ${c.createdBy || "-"}`;
      mCDetail.textContent = c.detail || "‚Äî";
      mCLoc.textContent = `üìç ${c.location?.text || "-"}`;

      if (c.photoUrl) {
        mCPhoto.href = c.photoUrl;
        mCPhoto.textContent = "Lihat Foto";
        mCPhoto.classList.remove("hidden");
      } else {
        mCPhoto.classList.add("hidden");
      }

      openCModal();
    }

    document.querySelectorAll(".btnCStatus").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if (!selectedComplaint) return;
        const status = btn.dataset.status;
        const note = (mCNote.value || "").trim();

        try{
          showCAlert("Menyimpan‚Ä¶");

          await updateDoc(doc(db, "complaints", selectedComplaint.id), {
            status,
            handledBy: currentUser.uid
          });

          await addDoc(collection(db, "complaints", selectedComplaint.id, "updates"), {
            status,
            note: note || `Status diubah menjadi ${status.toUpperCase()}.`,
            photoUrl: "",
            createdBy: currentUser.uid,
            createdAt: serverTimestamp()
          });

          await loadComplaints();

          const updated = cacheComplaints.find(x=>x.id===selectedComplaint.id);
          if (updated) {
            selectedComplaint = updated;
            mCMeta.textContent = `${(updated.status || "received").toUpperCase()} ‚Ä¢ ${fmtDate(updated.createdAt)} ‚Ä¢ oleh ${updated.createdBy || "-"}`;
          }

          showCAlert("Tersimpan ‚úì");
          setTimeout(()=>hideCAlert(), 900);
        }catch(err){
          console.error(err);
          showCAlert("Gagal update. Cek Firestore Rules.");
        }
      });
    });

    // ===== ROLE REQUESTS (KT only unless super_admin) =====
    function renderRoleReq(){
      roleList.innerHTML = "";
      roleEmpty.classList.toggle("hidden", cacheRoleReq.length !== 0);

      cacheRoleReq.forEach(r=>{
        const html = `
          <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-extrabold">Request: ${esc((r.requestedRole || "-").replaceAll("_"," "))}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">uid: ${esc(r.uid || "-")} ‚Ä¢ ${fmtDate(r.createdAt)}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">note: ${esc(r.note || "-")}</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button class="btnRoleApprove rounded-2xl bg-white px-3 py-2 text-xs font-extrabold text-slate-950" data-id="${r.id}">Approve</button>
                <button class="btnRoleReject rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-extrabold hover:bg-white/10" data-id="${r.id}">Reject</button>
              </div>
            </div>
          </div>
        `;
        roleList.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll(".btnRoleApprove").forEach(b=> b.addEventListener("click", ()=>approveRoleReq(b.dataset.id)));
      document.querySelectorAll(".btnRoleReject").forEach(b=> b.addEventListener("click", ()=>rejectRoleReq(b.dataset.id)));
    }

    async function loadRoleReq(){
      if (!neighborhoodId) { cacheRoleReq=[]; renderRoleReq(); return; }

      const qs = query(
        collection(db, "role_requests"),
        where("neighborhoodId", "==", neighborhoodId),
        where("status", "==", "pending"),
        orderBy("createdAt", "desc"),
        limit(40)
      );
      const snap = await getDocs(qs);
      const items = [];
      snap.forEach(d=> items.push({ id:d.id, ...d.data() }));

      const superAdmin = isSuper(profile.role || "");
      cacheRoleReq = superAdmin ? items : items.filter(x => (x.requestedRole || "").startsWith("kt_"));
      renderRoleReq();
    }

    async function approveRoleReq(reqId){
      const r = cacheRoleReq.find(x=>x.id===reqId);
      if (!r) return;

      if (!isSuper(profile.role || "") && !(r.requestedRole || "").startsWith("kt_")) {
        alert("Akses KT hanya untuk role KT.");
        return;
      }

      if (!confirm(`Approve role "${r.requestedRole}" untuk uid ${r.uid}?`)) return;

      try{
        await updateDoc(doc(db, "role_requests", reqId), {
          status: "approved",
          reviewedBy: currentUser.uid,
          reviewedAt: serverTimestamp()
        });

        await updateDoc(doc(db, "users", r.uid), {
          role: r.requestedRole,
          status: "active",
          verifiedBy: currentUser.uid,
          verifiedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        await loadRoleReq();
      }catch(err){
        console.error(err);
        alert("Gagal approve role. Cek Firestore Rules.");
      }
    }

    async function rejectRoleReq(reqId){
      const reason = prompt("Alasan reject (opsional):") || "";
      try{
        await updateDoc(doc(db, "role_requests", reqId), {
          status: "rejected",
          reviewedBy: currentUser.uid,
          reviewedAt: serverTimestamp(),
          reason
        });
        await loadRoleReq();
      }catch(err){
        console.error(err);
        alert("Gagal reject. Cek Firestore Rules.");
      }
    }

    // ===== RELOAD ALL =====
    async function reloadAll(){
      await Promise.all([
        loadEvents(),
        loadPendingTx(),
        loadComplaints(),
        loadRoleReq()
      ]);
    }
    window.__reloadAdmin = reloadAll;

    // Guard
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { go(ROUTES.login); return; }
      const ok = await guardAndLoad(user);
      if (!ok) return;
      await reloadAll();
    });
  </script>
</body>
</html>
