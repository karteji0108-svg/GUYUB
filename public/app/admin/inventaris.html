<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Inventaris | GUYUB</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 overflow-y-auto">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-amber-950/25"></div>
    <div class="absolute -top-32 -right-24 h-80 w-80 rounded-full bg-amber-500/10 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-24 h-96 w-96 rounded-full bg-sky-500/10 blur-3xl"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/60 backdrop-blur-xl">
    <div class="mx-auto max-w-md px-5 py-4 flex items-center justify-between gap-3">
      <div>
        <div class="text-sm font-extrabold tracking-tight">Inventaris</div>
        <div id="subText" class="text-[11px] text-slate-300/80">Memuat‚Ä¶</div>
      </div>
      <div class="flex items-center gap-2">
        <a href="/app/home.html" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">Home</a>
        <button id="btnReload" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">‚Üª</button>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <div class="mx-auto max-w-md px-5 pt-4 space-y-3">
    <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-4">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="text-xs font-bold text-slate-300">Organisasi</div>
          <select id="orgPick" class="mt-2 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20">
            <option value="rt">RT</option>
            <option value="pkk">PKK</option>
            <option value="kt">Karang Taruna</option>
          </select>
          <div class="mt-2 text-[11px] text-slate-400">Admin bisa mengelola inventaris org-nya.</div>
        </div>
        <div>
          <div class="text-xs font-bold text-slate-300">Status</div>
          <select id="statusPick" class="mt-2 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20">
            <option value="all">Semua</option>
            <option value="available">Tersedia</option>
            <option value="borrowed">Dipinjam</option>
            <option value="maintenance">Perbaikan</option>
            <option value="lost">Hilang</option>
          </select>
        </div>
      </div>

      <div class="mt-3">
        <input id="search" type="text" placeholder="Cari barang / kategori / lokasi‚Ä¶"
          class="w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />
      </div>

      <div class="mt-3 flex items-center justify-between gap-3">
        <div id="rolePill" class="text-[11px] text-slate-300/80">‚Äî</div>
        <button id="btnAdd" class="hidden rounded-2xl bg-white px-4 py-3 text-xs font-extrabold text-slate-950">
          + Tambah Barang
        </button>
      </div>
    </div>

    <!-- Summary -->
    <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-4">
      <div class="grid grid-cols-3 gap-3">
        <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
          <div class="text-[11px] text-slate-300/80">Item</div>
          <div id="sumItems" class="mt-1 text-lg font-extrabold">0</div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
          <div class="text-[11px] text-slate-300/80">Total Qty</div>
          <div id="sumQty" class="mt-1 text-lg font-extrabold">0</div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
          <div class="text-[11px] text-slate-300/80">Dipinjam</div>
          <div id="sumBorrowed" class="mt-1 text-lg font-extrabold">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- List -->
  <main class="mx-auto max-w-md px-5 pb-24 pt-5 space-y-3">
    <div id="list" class="space-y-3"></div>
    <div id="empty" class="hidden rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6 text-center text-sm text-slate-300/80">
      Belum ada data inventaris.
    </div>
  </main>

  <!-- Modal (Add/Edit) -->
  <div id="modal" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-x-0 bottom-0 mx-auto max-w-md px-5 pb-5">
      <div class="rounded-3xl border border-white/10 bg-slate-950/80 backdrop-blur-xl p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="mTitle" class="text-lg font-extrabold">Tambah Barang</div>
            <div class="mt-1 text-xs text-slate-300/80">Data akan tersimpan ke Firestore.</div>
          </div>
          <button id="btnClose" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">
            Tutup
          </button>
        </div>

        <div id="mAlert" class="hidden mt-4 rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-xs text-slate-200"></div>

        <form id="form" class="mt-4 space-y-3">
          <div>
            <label class="text-xs font-semibold text-slate-300">Nama Barang</label>
            <input id="fName" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="contoh: Tenda / Sound system" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-300">Kategori</label>
              <input id="fCat"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="contoh: Peralatan acara" />
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">Lokasi</label>
              <input id="fLoc"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="contoh: Gudang RW" />
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-300">Qty</label>
              <input id="fQty" type="number" min="0" value="1"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">Satuan</label>
              <input id="fUnit" value="pcs"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="pcs/unit/set" />
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">Kondisi</label>
              <select id="fCond"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20">
                <option value="good">Baik</option>
                <option value="fair">Cukup</option>
                <option value="bad">Buruk</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-300">Status</label>
              <select id="fStatus"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20">
                <option value="available">Tersedia</option>
                <option value="borrowed">Dipinjam</option>
                <option value="maintenance">Perbaikan</option>
                <option value="lost">Hilang</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">Catatan</label>
              <input id="fNote"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="opsional" />
            </div>
          </div>

          <button id="btnSave" class="w-full rounded-2xl bg-white px-4 py-3 text-sm font-extrabold text-slate-950 disabled:opacity-60">
            Simpan
          </button>

          <button id="btnDelete" type="button"
            class="hidden w-full rounded-2xl border border-white/10 bg-rose-500/15 px-4 py-3 text-sm font-extrabold text-rose-200 hover:bg-rose-500/20">
            Hapus Item
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // DOM
    const subText = document.getElementById("subText");
    const rolePill = document.getElementById("rolePill");
    const btnReload = document.getElementById("btnReload");

    const orgPick = document.getElementById("orgPick");
    const statusPick = document.getElementById("statusPick");
    const search = document.getElementById("search");
    const btnAdd = document.getElementById("btnAdd");

    const list = document.getElementById("list");
    const empty = document.getElementById("empty");

    const sumItems = document.getElementById("sumItems");
    const sumQty = document.getElementById("sumQty");
    const sumBorrowed = document.getElementById("sumBorrowed");

    // Modal
    const modal = document.getElementById("modal");
    const btnClose = document.getElementById("btnClose");
    const mTitle = document.getElementById("mTitle");
    const mAlert = document.getElementById("mAlert");

    const form = document.getElementById("form");
    const fName = document.getElementById("fName");
    const fCat = document.getElementById("fCat");
    const fLoc = document.getElementById("fLoc");
    const fQty = document.getElementById("fQty");
    const fUnit = document.getElementById("fUnit");
    const fCond = document.getElementById("fCond");
    const fStatus = document.getElementById("fStatus");
    const fNote = document.getElementById("fNote");
    const btnSave = document.getElementById("btnSave");
    const btnDelete = document.getElementById("btnDelete");

    function fmtDate(ts) {
      try { const d = ts?.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString("id-ID",{year:"numeric",month:"short",day:"2-digit"}); }
      catch { return "‚Äî"; }
    }
    function esc(s=""){ return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
    function badge(text){
      return `<span class="inline-flex rounded-full border border-white/10 bg-white/10 px-3 py-1 text-[11px] font-extrabold">${esc(text)}</span>`;
    }
    function openModal(){ modal.classList.remove("hidden"); }
    function closeModal(){
      modal.classList.add("hidden");
      mAlert.classList.add("hidden"); mAlert.textContent = "";
    }
    btnClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

    // Local state
    let me = null;
    let profile = null;
    let neighborhoodId = null;

    let cache = [];
    let editingId = null;

    function isAdmin(role){
      role = role || "";
      return role === "super_admin" || role.startsWith("rt_") || role.startsWith("pkk_") || role.startsWith("kt_");
    }
    function roleOrg(role){
      if ((role||"").startsWith("rt_")) return "rt";
      if ((role||"").startsWith("pkk_")) return "pkk";
      if ((role||"").startsWith("kt_")) return "kt";
      return null;
    }

    function applyAccessUI(){
      const admin = isAdmin(profile?.role);
      const org = orgPick.value;

      if (!admin) {
        btnAdd.classList.add("hidden");
        rolePill.textContent = `Mode: Warga (read-only)`;
        orgPick.disabled = false; // warga boleh pilih org untuk lihat
        return;
      }

      const myOrg = roleOrg(profile?.role);
      if (profile?.role !== "super_admin" && myOrg) {
        orgPick.value = myOrg;
        orgPick.disabled = true;
      } else {
        orgPick.disabled = false;
      }

      btnAdd.classList.remove("hidden");
      rolePill.textContent = `Mode: Admin (${profile?.role})`;
    }

    function render(){
      const org = orgPick.value;
      const st = statusPick.value;
      const q = (search.value || "").trim().toLowerCase();

      const items = cache
        .filter(x => x.org === org)
        .filter(x => st === "all" ? true : (x.status || "available") === st)
        .filter(x => {
          if (!q) return true;
          return (x.name||"").toLowerCase().includes(q) ||
                 (x.category||"").toLowerCase().includes(q) ||
                 (x.locationText||"").toLowerCase().includes(q);
        });

      // summary
      sumItems.textContent = String(items.length);
      sumQty.textContent = String(items.reduce((a,b)=>a + Number(b.qty||0), 0));
      sumBorrowed.textContent = String(items.filter(i => (i.status||"") === "borrowed").length);

      list.innerHTML = "";
      empty.classList.toggle("hidden", items.length !== 0);

      items.forEach(it=>{
        const stText = (it.status || "available").toUpperCase();
        const condText = (it.condition || "good").toUpperCase();
        const info = [
          badge(stText),
          badge(`Kondisi: ${condText}`),
          badge(`Qty: ${Number(it.qty||0)} ${esc(it.unit||"pcs")}`)
        ].join(" ");

        const canEdit = isAdmin(profile?.role) && (profile?.role === "super_admin" || roleOrg(profile?.role) === it.org);

        const html = `
          <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-5">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-extrabold">${esc(it.name || "Barang")}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">${esc(it.category || "-")} ‚Ä¢ ${esc(it.locationText || "-")}</div>
                <div class="mt-3 flex flex-wrap gap-2">${info}</div>
                <div class="mt-3 text-[11px] text-slate-400">
                  Update: ${it.updatedAt ? fmtDate(it.updatedAt) : (it.createdAt ? fmtDate(it.createdAt) : "‚Äî")}
                </div>
                ${it.note ? `<div class="mt-2 text-xs text-slate-200/90">üìù ${esc(it.note)}</div>` : ""}
              </div>
              ${canEdit ? `
                <button class="btnEdit rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10"
                  data-id="${it.id}">
                  Edit
                </button>` : ``}
            </div>
          </div>
        `;
        list.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll(".btnEdit").forEach(b=>{
        b.addEventListener("click", ()=>openEdit(b.dataset.id));
      });
    }

    function showAlert(msg){
      mAlert.textContent = msg;
      mAlert.classList.remove("hidden");
    }

    function resetForm(){
      editingId = null;
      mTitle.textContent = "Tambah Barang";
      fName.value = "";
      fCat.value = "";
      fLoc.value = "";
      fQty.value = 1;
      fUnit.value = "pcs";
      fCond.value = "good";
      fStatus.value = "available";
      fNote.value = "";
      btnDelete.classList.add("hidden");
      mAlert.classList.add("hidden"); mAlert.textContent = "";
    }

    function openAdd(){
      resetForm();
      openModal();
    }

    function openEdit(id){
      const it = cache.find(x=>x.id===id);
      if (!it) return;

      editingId = id;
      mTitle.textContent = "Edit Barang";
      fName.value = it.name || "";
      fCat.value = it.category || "";
      fLoc.value = it.locationText || "";
      fQty.value = Number(it.qty || 0);
      fUnit.value = it.unit || "pcs";
      fCond.value = it.condition || "good";
      fStatus.value = it.status || "available";
      fNote.value = it.note || "";
      btnDelete.classList.remove("hidden");
      openModal();
    }

    btnAdd.addEventListener("click", openAdd);
    btnReload.addEventListener("click", ()=>window.__reload && window.__reload());

    orgPick.addEventListener("change", render);
    statusPick.addEventListener("change", render);
    search.addEventListener("input", render);
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc,
      collection, query, where, orderBy, limit, getDocs,
      addDoc, updateDoc, deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚úÖ GANTI sesuai Firebase kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const ROUTES = {
      home: "/app/home.html",
      login: "/login.html",
      register: "/register.html"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function go(p){ window.location.replace(p); }
    function roleOrg(role){
      if ((role||"").startsWith("rt_")) return "rt";
      if ((role||"").startsWith("pkk_")) return "pkk";
      if ((role||"").startsWith("kt_")) return "kt";
      return null;
    }
    function isAdmin(role){
      role = role || "";
      return role === "super_admin" || role.startsWith("rt_") || role.startsWith("pkk_") || role.startsWith("kt_");
    }
    function canWrite(role, org){
      if (role === "super_admin") return true;
      return roleOrg(role) === org;
    }

    async function loadInventory(){
      if (!neighborhoodId) { cache = []; render(); return; }

      // Ambil 120 item terakhir untuk lingkungan ini
      const qs = query(
        collection(db, "inventory_items"),
        where("neighborhoodId", "==", neighborhoodId),
        orderBy("createdAt", "desc"),
        limit(120)
      );
      const snap = await getDocs(qs);
      const items = [];
      snap.forEach(d=> items.push({ id:d.id, ...d.data() }));
      cache = items;
      render();
    }

    window.__reload = loadInventory;

    // Save form
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      if (!me || !profile) return;
      if (!neighborhoodId) return showAlert("neighborhoodId belum diatur. Isi dulu di Profil.");

      const org = orgPick.value;
      if (!isAdmin(profile.role) || !canWrite(profile.role, org)) {
        return showAlert("Akses ditolak. Kamu tidak punya izin mengelola inventaris org ini.");
      }

      const payload = {
        neighborhoodId,
        org,
        name: (fName.value||"").trim(),
        category: (fCat.value||"").trim(),
        locationText: (fLoc.value||"").trim(),
        qty: Number(fQty.value||0),
        unit: (fUnit.value||"").trim() || "pcs",
        condition: fCond.value,
        status: fStatus.value,
        note: (fNote.value||"").trim(),
      };

      if (!payload.name) return showAlert("Nama barang wajib diisi.");

      try{
        btnSave.disabled = true;
        btnSave.textContent = "Menyimpan‚Ä¶";
        mAlert.classList.add("hidden"); mAlert.textContent = "";

        if (!editingId) {
          await addDoc(collection(db, "inventory_items"), {
            ...payload,
            createdAt: serverTimestamp(),
            createdBy: me.uid,
            updatedAt: serverTimestamp(),
            updatedBy: me.uid,
          });
        } else {
          await updateDoc(doc(db, "inventory_items", editingId), {
            ...payload,
            updatedAt: serverTimestamp(),
            updatedBy: me.uid,
          });
        }

        btnSave.disabled = false;
        btnSave.textContent = "Simpan";
        closeModal();
        await loadInventory();
      }catch(err){
        console.error(err);
        btnSave.disabled = false;
        btnSave.textContent = "Simpan";
        showAlert("Gagal menyimpan. Cek Firestore Rules / index.");
      }
    });

    // Delete
    btnDelete.addEventListener("click", async ()=>{
      if (!editingId) return;
      if (!confirm("Hapus item ini?")) return;

      const org = orgPick.value;
      if (!isAdmin(profile.role) || !canWrite(profile.role, org)) {
        return showAlert("Akses ditolak.");
      }

      try{
        btnDelete.disabled = true;
        btnDelete.textContent = "Menghapus‚Ä¶";
        await deleteDoc(doc(db, "inventory_items", editingId));
        btnDelete.disabled = false;
        btnDelete.textContent = "Hapus Item";
        closeModal();
        await loadInventory();
      }catch(err){
        console.error(err);
        btnDelete.disabled = false;
        btnDelete.textContent = "Hapus Item";
        showAlert("Gagal hapus. Cek Firestore Rules.");
      }
    });

    // Guard
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { go(ROUTES.login); return; }
      me = user;

      const usnap = await getDoc(doc(db, "users", user.uid));
      if (!usnap.exists()) { go(ROUTES.register); return; }

      profile = usnap.data();
      neighborhoodId = profile.neighborhoodId || null;

      subText.textContent = neighborhoodId
        ? `Lingkungan: ${neighborhoodId} ‚Ä¢ Role: ${profile.role || "warga"}`
        : `Role: ${profile.role || "warga"} (neighborhoodId belum diatur)`;

      // Default org selection
      const myOrg = roleOrg(profile.role || "");
      if (profile.role !== "super_admin" && myOrg) {
        orgPick.value = myOrg;
      } else {
        orgPick.value = "rt";
      }

      applyAccessUI();
      await loadInventory();
    });
  </script>
</body>
</html>
