<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Verifikasi | GUYUB Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 overflow-y-auto">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-indigo-950/25"></div>
    <div class="absolute -top-32 -right-24 h-80 w-80 rounded-full bg-indigo-500/10 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-24 h-96 w-96 rounded-full bg-emerald-500/10 blur-3xl"></div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-20 border-b border-white/10 bg-slate-950/60 backdrop-blur-xl">
    <div class="mx-auto max-w-md px-5 py-4 flex items-center justify-between gap-3">
      <div>
        <div class="text-sm font-extrabold tracking-tight">Verifikasi</div>
        <div id="subText" class="text-[11px] text-slate-300/80">Memuatâ€¦</div>
      </div>
      <div class="flex items-center gap-2">
        <a href="/app/home.html" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">Home</a>
        <button id="btnReload" class="rounded-2xl border border-white/10 bg-white/5 px-4 py-2 text-xs font-extrabold hover:bg-white/10">â†»</button>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="mx-auto max-w-md px-5 pt-4">
    <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-2">
      <div class="grid grid-cols-3 gap-2 text-[11px]">
        <button class="tabBtn rounded-2xl bg-white/10 px-2 py-3 font-extrabold" data-tab="requests">Role Request</button>
        <button class="tabBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-tab="users">Akun</button>
        <button class="tabBtn rounded-2xl px-2 py-3 text-slate-300/80 hover:bg-white/5" data-tab="neigh">Lingkungan</button>
      </div>
    </div>
  </div>

  <main class="mx-auto max-w-md px-5 pb-10 pt-5 space-y-5">
    <!-- REQUESTS -->
    <section id="tab_requests" class="space-y-4">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-extrabold">Role Requests (Pending)</div>
            <div class="mt-1 text-xs text-slate-300/80">Approve/Reject permintaan role.</div>
          </div>
          <span class="text-[11px] text-slate-400">max 50</span>
        </div>

        <div class="mt-4">
          <input id="rqSearch" type="text" placeholder="Cari uid / role / noteâ€¦"
            class="w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />
          <div class="mt-2 text-[11px] text-slate-400">Tip: untuk admin non-super, sebaiknya hanya approve role sesuai organisasinya.</div>
        </div>

        <div id="rqList" class="mt-4 space-y-3"></div>
        <div id="rqEmpty" class="hidden mt-4 text-center text-xs text-slate-300/80">Tidak ada request pending.</div>
      </div>
    </section>

    <!-- USERS -->
    <section id="tab_users" class="hidden space-y-4">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="text-sm font-extrabold">Verifikasi Akun (Users)</div>
        <div class="mt-1 text-xs text-slate-300/80">Aktifkan / suspend akun user.</div>

        <input id="uSearch" type="text" placeholder="Cari nama / uid / no hpâ€¦"
          class="mt-4 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20" />

        <div id="uList" class="mt-4 space-y-3"></div>
        <div id="uEmpty" class="hidden mt-4 text-center text-xs text-slate-300/80">Tidak ada user ditemukan.</div>
      </div>
    </section>

    <!-- NEIGHBORHOOD -->
    <section id="tab_neigh" class="hidden space-y-4">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
        <div class="text-sm font-extrabold">Set Kode Lingkungan</div>
        <div class="mt-1 text-xs text-slate-300/80">Isi <b>neighborhoodId</b> user agar kas/aduan/event terhubung.</div>

        <form id="neighForm" class="mt-4 space-y-3">
          <div>
            <label class="text-xs font-semibold text-slate-300">UID User</label>
            <input id="nUid" type="text" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="uid firebase user" />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Neighborhood ID</label>
            <input id="nNeigh" type="text" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="contoh: RW01_RT03 / CILOSARI-A" />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Catatan (opsional)</label>
            <input id="nNote" type="text"
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="contoh: ditetapkan oleh admin" />
          </div>

          <button id="btnNeigh" class="w-full rounded-2xl bg-white px-4 py-3 text-sm font-extrabold text-slate-950 disabled:opacity-60">
            Simpan Neighborhood
          </button>

          <div id="nAlert" class="hidden rounded-2xl border border-white/10 bg-slate-950/30 px-4 py-3 text-xs text-slate-200"></div>
        </form>
      </div>
    </section>
  </main>

  <script>
    // Tabs UI
    const tabBtns = document.querySelectorAll(".tabBtn");
    const tabs = {
      requests: document.getElementById("tab_requests"),
      users: document.getElementById("tab_users"),
      neigh: document.getElementById("tab_neigh"),
    };
    function setTab(name){
      tabBtns.forEach(b=>{
        const a = b.dataset.tab === name;
        b.className = "tabBtn rounded-2xl px-2 py-3 text-[11px] " + (a ? "bg-white/10 font-extrabold" : "text-slate-300/80 hover:bg-white/5");
      });
      Object.entries(tabs).forEach(([k, el])=> el.classList.toggle("hidden", k !== name));
    }
    tabBtns.forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));
    setTab("requests");

    // DOM
    const subText = document.getElementById("subText");
    const btnReload = document.getElementById("btnReload");

    const rqSearch = document.getElementById("rqSearch");
    const rqList = document.getElementById("rqList");
    const rqEmpty = document.getElementById("rqEmpty");

    const uSearch = document.getElementById("uSearch");
    const uList = document.getElementById("uList");
    const uEmpty = document.getElementById("uEmpty");

    const nAlert = document.getElementById("nAlert");
    const btnNeigh = document.getElementById("btnNeigh");
    function showNAlert(msg){ nAlert.textContent = msg; nAlert.classList.remove("hidden"); }
    function hideNAlert(){ nAlert.classList.add("hidden"); nAlert.textContent=""; }

    function fmtDate(ts) {
      try { const d = ts?.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString("id-ID",{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}); }
      catch { return "â€”"; }
    }
    function esc(s=""){ return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

    // local caches
    let cacheRequests = [];
    let cacheUsers = [];

    // renderers
    function renderRequests(){
      const q = (rqSearch.value || "").trim().toLowerCase();
      const items = cacheRequests.filter(r=>{
        if (!q) return true;
        return (r.uid||"").toLowerCase().includes(q) ||
               (r.requestedRole||"").toLowerCase().includes(q) ||
               (r.note||"").toLowerCase().includes(q);
      });

      rqList.innerHTML = "";
      rqEmpty.classList.toggle("hidden", items.length !== 0);

      items.forEach(r=>{
        const html = `
          <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-extrabold">Request: ${esc((r.requestedRole||"-").replaceAll("_"," "))}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">uid: ${esc(r.uid||"-")} â€¢ ${fmtDate(r.createdAt)}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">note: ${esc(r.note||"-")}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">neigh: ${esc(r.neighborhoodId||"-")}</div>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button class="btnRqApprove rounded-2xl bg-white px-3 py-2 text-xs font-extrabold text-slate-950" data-id="${r.id}">Approve</button>
                <button class="btnRqReject rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-extrabold hover:bg-white/10" data-id="${r.id}">Reject</button>
              </div>
            </div>
          </div>
        `;
        rqList.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll(".btnRqApprove").forEach(b=> b.addEventListener("click", ()=>window.__approveReq && window.__approveReq(b.dataset.id)));
      document.querySelectorAll(".btnRqReject").forEach(b=> b.addEventListener("click", ()=>window.__rejectReq && window.__rejectReq(b.dataset.id)));
    }

    function renderUsers(){
      const q = (uSearch.value || "").trim().toLowerCase();
      const items = cacheUsers.filter(u=>{
        if (!q) return true;
        return (u.uid||"").toLowerCase().includes(q) ||
               (u.name||"").toLowerCase().includes(q) ||
               (u.phone||"").toLowerCase().includes(q);
      });

      uList.innerHTML = "";
      uEmpty.classList.toggle("hidden", items.length !== 0);

      items.forEach(u=>{
        const st = u.status || "pending";
        const pill = st === "active"
          ? `<span class="inline-flex rounded-full border border-white/10 bg-emerald-500/15 px-3 py-1 text-[11px] font-extrabold text-emerald-200">ACTIVE</span>`
          : (st === "suspended"
            ? `<span class="inline-flex rounded-full border border-white/10 bg-rose-500/15 px-3 py-1 text-[11px] font-extrabold text-rose-200">SUSPENDED</span>`
            : `<span class="inline-flex rounded-full border border-white/10 bg-white/10 px-3 py-1 text-[11px] font-extrabold">PENDING</span>`);

        const html = `
          <div class="rounded-2xl border border-white/10 bg-slate-950/30 p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <div class="text-sm font-extrabold">${esc(u.name || "Tanpa Nama")}</div>
                  ${pill}
                </div>
                <div class="mt-1 text-[11px] text-slate-300/80">uid: ${esc(u.uid||"-")}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">role: <b>${esc(u.role || "warga")}</b> â€¢ neigh: ${esc(u.neighborhoodId || "-")}</div>
                <div class="mt-1 text-[11px] text-slate-300/80">phone: ${esc(u.phone || "-")}</div>
              </div>
              <div class="space-y-2">
                <button class="btnActivate w-full rounded-2xl bg-white px-3 py-2 text-xs font-extrabold text-slate-950" data-uid="${u.uid}">Aktifkan</button>
                <button class="btnSuspend w-full rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-xs font-extrabold hover:bg-white/10" data-uid="${u.uid}">Suspend</button>
              </div>
            </div>
          </div>
        `;
        uList.insertAdjacentHTML("beforeend", html);
      });

      document.querySelectorAll(".btnActivate").forEach(b=> b.addEventListener("click", ()=>window.__setUserStatus && window.__setUserStatus(b.dataset.uid, "active")));
      document.querySelectorAll(".btnSuspend").forEach(b=> b.addEventListener("click", ()=>window.__setUserStatus && window.__setUserStatus(b.dataset.uid, "suspended")));
    }

    rqSearch.addEventListener("input", renderRequests);
    uSearch.addEventListener("input", renderUsers);
    btnReload.addEventListener("click", ()=>window.__reloadAll && window.__reloadAll());
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, updateDoc,
      collection, query, where, orderBy, limit, getDocs,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // âœ… GANTI sesuai Firebase kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const ROUTES = {
      home: "/app/home.html",
      login: "/login.html",
      register: "/register.html"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let me = null;
    let myProfile = null;
    let neighborhoodId = null;

    function go(p){ window.location.replace(p); }

    // ðŸ”’ Default: super_admin + rt_* saja (aman).
    // Kalau kamu mau semua admin (rt/pkk/kt) boleh akses verifikasi, ubah jadi:
    // return role.startsWith("rt_") || role.startsWith("pkk_") || role.startsWith("kt_") || role==="super_admin"
    function allowed(role){
      return role === "super_admin" || (role || "").startsWith("rt_");
    }
    function isSuper(role){ return role === "super_admin"; }

    async function guard(user){
      me = user;
      const usnap = await getDoc(doc(db, "users", user.uid));
      if (!usnap.exists()) { go(ROUTES.register); return false; }

      myProfile = usnap.data();
      if (!allowed(myProfile.role || "")) { go(ROUTES.home); return false; }

      neighborhoodId = myProfile.neighborhoodId || null;
      subText.textContent = neighborhoodId
        ? `Lingkungan: ${neighborhoodId} â€¢ Role: ${myProfile.role}`
        : `Role: ${myProfile.role} (neighborhoodId belum diatur)`;

      return true;
    }

    async function loadRoleRequests(){
      rqList.innerHTML = `<div class="text-xs text-slate-300/80">Memuatâ€¦</div>`;

      // super_admin bisa lihat semua pending (tanpa filter neighborhood)
      // admin RT biasa: dibatasi neighborhoodId supaya aman
      let qs;
      if (isSuper(myProfile.role || "")) {
        qs = query(
          collection(db, "role_requests"),
          where("status", "==", "pending"),
          orderBy("createdAt", "desc"),
          limit(50)
        );
      } else {
        if (!neighborhoodId) { cacheRequests = []; renderRequests(); return; }
        qs = query(
          collection(db, "role_requests"),
          where("status", "==", "pending"),
          where("neighborhoodId", "==", neighborhoodId),
          orderBy("createdAt", "desc"),
          limit(50)
        );
      }

      const snap = await getDocs(qs);
      const items = [];
      snap.forEach(d=> items.push({ id:d.id, ...d.data() }));
      cacheRequests = items;
      renderRequests();
    }

    async function loadUsers(){
      uList.innerHTML = `<div class="text-xs text-slate-300/80">Memuatâ€¦</div>`;

      // super_admin: ambil user terbaru global
      // admin RT: batasi neighborhood
      let qs;
      if (isSuper(myProfile.role || "")) {
        qs = query(
          collection(db, "users"),
          orderBy("createdAt", "desc"),
          limit(50)
        );
      } else {
        if (!neighborhoodId) { cacheUsers = []; renderUsers(); return; }
        qs = query(
          collection(db, "users"),
          where("neighborhoodId", "==", neighborhoodId),
          orderBy("createdAt", "desc"),
          limit(50)
        );
      }

      const snap = await getDocs(qs);
      const items = [];
      snap.forEach(d=> items.push({ uid:d.id, ...d.data() }));
      cacheUsers = items;
      renderUsers();
    }

    // ===== Actions =====
    window.__approveReq = async (reqId) => {
      const r = cacheRequests.find(x=>x.id===reqId);
      if (!r) return;

      // non-super: boleh approve hanya untuk neighborhood sama
      if (!isSuper(myProfile.role || "") && neighborhoodId && r.neighborhoodId !== neighborhoodId) {
        alert("Akses ditolak (beda lingkungan).");
        return;
      }

      // non-super: batasi hanya role RT (aman)
      if (!isSuper(myProfile.role || "") && !(r.requestedRole || "").startsWith("rt_")) {
        alert("Admin ini hanya bisa approve role RT (ubah di kode jika perlu).");
        return;
      }

      if (!confirm(`Approve role "${r.requestedRole}" untuk uid ${r.uid}?`)) return;

      try{
        // update request
        await updateDoc(doc(db, "role_requests", reqId), {
          status: "approved",
          reviewedBy: me.uid,
          reviewedAt: serverTimestamp()
        });

        // update user role
        await updateDoc(doc(db, "users", r.uid), {
          role: r.requestedRole,
          status: "active",
          verifiedBy: me.uid,
          verifiedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        await loadRoleRequests();
        await loadUsers();
      }catch(err){
        console.error(err);
        alert("Gagal approve. Cek Firestore Rules.");
      }
    };

    window.__rejectReq = async (reqId) => {
      const r = cacheRequests.find(x=>x.id===reqId);
      if (!r) return;

      if (!isSuper(myProfile.role || "") && neighborhoodId && r.neighborhoodId !== neighborhoodId) {
        alert("Akses ditolak (beda lingkungan).");
        return;
      }

      const reason = prompt("Alasan reject (opsional):") || "";
      try{
        await updateDoc(doc(db, "role_requests", reqId), {
          status: "rejected",
          reviewedBy: me.uid,
          reviewedAt: serverTimestamp(),
          reason
        });
        await loadRoleRequests();
      }catch(err){
        console.error(err);
        alert("Gagal reject. Cek Firestore Rules.");
      }
    };

    window.__setUserStatus = async (uid, status) => {
      if (!uid) return;
      const note = prompt("Catatan (opsional):") || "";

      // non-super: batasi neighborhood
      if (!isSuper(myProfile.role || "")) {
        const u = cacheUsers.find(x=>x.uid===uid);
        if (!u || (neighborhoodId && u.neighborhoodId !== neighborhoodId)) {
          alert("Akses ditolak (user beda lingkungan / tidak ditemukan di list).");
          return;
        }
      }

      try{
        await updateDoc(doc(db, "users", uid), {
          status,
          statusNote: note,
          statusBy: me.uid,
          statusAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        await loadUsers();
      }catch(err){
        console.error(err);
        alert("Gagal update status user. Cek Rules.");
      }
    };

    // Neighborhood form
    document.getElementById("neighForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hideNAlert();

      const uid = document.getElementById("nUid").value.trim();
      const neigh = document.getElementById("nNeigh").value.trim();
      const note = document.getElementById("nNote").value.trim();

      if (!uid || !neigh) return showNAlert("UID dan Neighborhood ID wajib diisi.");

      // non-super: hanya boleh set untuk lingkungan sendiri
      if (!isSuper(myProfile.role || "") && neighborhoodId && neigh !== neighborhoodId) {
        showNAlert("Admin non-super hanya boleh set neighborhood sesuai lingkungannya.");
        return;
      }

      try{
        btnNeigh.disabled = true;
        btnNeigh.textContent = "Menyimpanâ€¦";

        await updateDoc(doc(db, "users", uid), {
          neighborhoodId: neigh,
          neighborhoodSetBy: me.uid,
          neighborhoodSetAt: serverTimestamp(),
          neighborhoodNote: note,
          updatedAt: serverTimestamp()
        });

        btnNeigh.disabled = false;
        btnNeigh.textContent = "Simpan Neighborhood";
        showNAlert("Tersimpan âœ“");

        await loadUsers();
      }catch(err){
        console.error(err);
        btnNeigh.disabled = false;
        btnNeigh.textContent = "Simpan Neighborhood";
        showNAlert("Gagal menyimpan. Pastikan UID benar & Rules mengizinkan.");
      }
    });

    window.__reloadAll = async () => {
      await Promise.all([ loadRoleRequests(), loadUsers() ]);
    };

    // Guard
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { go(ROUTES.login); return; }
      const ok = await guard(user);
      if (!ok) return;
      await window.__reloadAll();
    });
  </script>
</body>
</html>
