<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Login | GUYUB</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 overflow-hidden">
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-emerald-950/40"></div>
    <div class="absolute -top-32 -right-24 h-80 w-80 rounded-full bg-emerald-500/10 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-24 h-96 w-96 rounded-full bg-sky-500/10 blur-3xl"></div>
  </div>

  <main class="h-full flex items-center justify-center px-6">
    <div class="w-full max-w-sm">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-7 shadow-2xl shadow-black/40">
        <div class="flex items-center gap-3">
          <div class="h-11 w-11 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-center">
            <span class="font-extrabold text-lg">G</span>
          </div>
          <div>
            <div class="text-lg font-extrabold tracking-tight">Masuk</div>
            <div class="text-xs text-slate-300/80">GUYUB • RT • PKK • Karang Taruna</div>
          </div>
        </div>

        <div id="alert" class="hidden mt-5 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-xs text-slate-200"></div>

        <form id="loginForm" class="mt-6 space-y-4">
          <div>
            <label class="text-xs font-semibold text-slate-300">Email</label>
            <input id="email" type="email" autocomplete="email" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="nama@email.com" />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Password</label>
            <input id="password" type="password" autocomplete="current-password" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="••••••••" />
            <button id="btnReset" type="button" class="mt-2 text-[11px] text-slate-300/80 hover:text-white">
              Lupa password?
            </button>
          </div>

          <button id="btnLogin" type="submit"
            class="w-full rounded-2xl bg-white px-4 py-3 text-sm font-extrabold text-slate-950 disabled:opacity-60">
            Masuk
          </button>

          <div class="flex items-center gap-3 py-2">
            <div class="h-px flex-1 bg-white/10"></div>
            <div class="text-[11px] text-slate-400">atau</div>
            <div class="h-px flex-1 bg-white/10"></div>
          </div>

          <button id="btnGoogle" type="button"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-bold text-slate-100 hover:bg-white/10 disabled:opacity-60">
            Masuk dengan Google
          </button>
        </form>

        <div class="mt-5 text-center text-xs text-slate-300/80">
          Belum punya akun?
          <a href="/register.html" class="font-bold text-white hover:underline">Daftar</a>
        </div>
      </div>

      <div class="mt-4 text-center text-[11px] text-slate-500">
        Tips: Setelah login, kamu akan diarahkan otomatis sesuai role (RT/PKK/KT/Warga).
      </div>
    </div>
  </main>

  <script>
    const alertBox = document.getElementById("alert");
    const btnLogin = document.getElementById("btnLogin");
    const btnGoogle = document.getElementById("btnGoogle");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");

    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.classList.remove("hidden");
    }
    function clearAlert() {
      alertBox.classList.add("hidden");
      alertBox.textContent = "";
    }
    function setLoading(isLoading) {
      btnLogin.disabled = isLoading;
      btnGoogle.disabled = isLoading;
      btnLogin.textContent = isLoading ? "Memproses…" : "Masuk";
    }
  </script>

  <script type="module">
    import { initFirebase, ROUTES, routeByRole } from "/assets/js/firebase.js";
    import {
      onAuthStateChanged,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const { auth, db } = initFirebase();

    // Fallback URL jika routeByRole gagal
    const DEFAULT_HOME = "/app/home.html";

    function go(path) {
      // Jika path kosong/undefined, gunakan default home
      const target = path || DEFAULT_HOME;
      console.log("Redirecting to:", target);
      window.location.replace(target);
    }

    async function redirectAfterLogin(uid) {
      try {
        const usnap = await getDoc(doc(db, "users", uid));
        
        // 1. Jika data user belum ada di Firestore -> ke Register
        if (!usnap.exists()) {
          console.warn("User auth sukses, tapi data Firestore tidak ditemukan.");
          go("/register.html");
          return;
        }

        const u = usnap.data();

        // 2. Cek status akun
        if ((u.status || "active") === "suspended") {
          throw new Error("Akun dinonaktifkan. Hubungi pengurus.");
        }

        // 3. Tentukan tujuan berdasarkan Role
        // Gunakan fallback ke DEFAULT_HOME jika routeByRole error/undefined
        let targetRoute = DEFAULT_HOME;
        if (typeof routeByRole === 'function') {
           const route = routeByRole(u.role || "warga");
           if (route) targetRoute = route;
        }
        
        go(targetRoute);

      } catch (error) {
        console.error("Redirect Error:", error);
        setLoading(false);
        showAlert(error.message || "Gagal memuat profil user.");
      }
    }

    // --- MAIN LISTENER (Single Source of Truth) ---
    // Logika redirect hanya dipanggil dari sini agar tidak bentrok
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User login (atau refresh saat sudah login)
        setLoading(true);
        clearAlert();
        await redirectAfterLogin(user.uid);
      } else {
        // User belum login / logout
        setLoading(false);
      }
    });

    // --- BUTTON HANDLERS ---
    
    // Email/password login
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert();

      const email = emailEl.value.trim();
      const password = passEl.value;

      try {
        setLoading(true);
        // HANYA melakukan login. Redirect ditangani onAuthStateChanged.
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.error(err);
        setLoading(false); // Matikan loading jika error
        let msg = "Login gagal. Cek email & password.";
        if (err.code === "auth/user-not-found") msg = "Akun belum terdaftar.";
        if (err.code === "auth/wrong-password") msg = "Password salah.";
        if (err.code === "auth/invalid-email") msg = "Format email salah.";
        if (err.code === "auth/too-many-requests") msg = "Terlalu banyak percobaan. Tunggu sebentar.";
        showAlert(msg);
      }
    });

    // Google login
    document.getElementById("btnGoogle").addEventListener("click", async () => {
      clearAlert();
      try {
        setLoading(true);
        const provider = new GoogleAuthProvider();
        // HANYA melakukan login. Redirect ditangani onAuthStateChanged.
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        setLoading(false);
        showAlert("Login Google dibatalkan atau gagal.");
      }
    });

    // Reset password
    document.getElementById("btnReset").addEventListener("click", async () => {
      clearAlert();
      const email = emailEl.value.trim();
      if (!email) {
        showAlert("Isi email dulu untuk reset password.");
        return;
      }
      try {
        setLoading(true);
        await sendPasswordResetEmail(auth, email);
        setLoading(false);
        showAlert("Cek email kamu (inbox/spam) untuk link reset password.");
      } catch (err) {
        console.error(err);
        setLoading(false);
        showAlert("Gagal kirim reset. Pastikan email benar.");
      }
    });
  </script>
</body>
</html>
