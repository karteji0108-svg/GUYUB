<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Login | GUYUB</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 overflow-hidden">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-emerald-950/40"></div>
    <div class="absolute -top-32 -right-24 h-80 w-80 rounded-full bg-emerald-500/10 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-24 h-96 w-96 rounded-full bg-sky-500/10 blur-3xl"></div>
  </div>

  <main class="h-full flex items-center justify-center px-6">
    <div class="w-full max-w-sm">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-7 shadow-2xl shadow-black/40">
        <div class="flex items-center gap-3">
          <div class="h-11 w-11 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-center">
            <span class="font-extrabold text-lg">G</span>
          </div>
          <div>
            <div class="text-lg font-extrabold tracking-tight">Masuk</div>
            <div class="text-xs text-slate-300/80">GUYUB • RT • PKK • Karang Taruna</div>
          </div>
        </div>

        <div id="alert" class="hidden mt-5 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-xs text-slate-200"></div>

        <form id="loginForm" class="mt-6 space-y-4">
          <div>
            <label class="text-xs font-semibold text-slate-300">Email</label>
            <input id="email" type="email" autocomplete="email" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="nama@email.com" />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Password</label>
            <input id="password" type="password" autocomplete="current-password" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="••••••••" />
            <button id="btnReset" type="button" class="mt-2 text-[11px] text-slate-300/80 hover:text-white">
              Lupa password?
            </button>
          </div>

          <button id="btnLogin" type="submit"
            class="w-full rounded-2xl bg-white px-4 py-3 text-sm font-extrabold text-slate-950 disabled:opacity-60">
            Masuk
          </button>

          <div class="flex items-center gap-3 py-2">
            <div class="h-px flex-1 bg-white/10"></div>
            <div class="text-[11px] text-slate-400">atau</div>
            <div class="h-px flex-1 bg-white/10"></div>
          </div>

          <button id="btnGoogle" type="button"
            class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm font-bold text-slate-100 hover:bg-white/10 disabled:opacity-60">
            Masuk dengan Google
          </button>
        </form>

        <div class="mt-5 text-center text-xs text-slate-300/80">
          Belum punya akun?
          <a href="/register.html" class="font-bold text-white hover:underline">Daftar</a>
        </div>
      </div>

      <div class="mt-4 text-center text-[11px] text-slate-500">
        Tips: Setelah login, kamu akan diarahkan otomatis sesuai role (RT/PKK/KT/Warga).
      </div>
    </div>
  </main>

  <script>
    const alertBox = document.getElementById("alert");
    const btnLogin = document.getElementById("btnLogin");
    const btnGoogle = document.getElementById("btnGoogle");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");

    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.classList.remove("hidden");
    }
    function clearAlert() {
      alertBox.classList.add("hidden");
      alertBox.textContent = "";
    }
    function setLoading(isLoading) {
      btnLogin.disabled = isLoading;
      btnGoogle.disabled = isLoading;
      btnLogin.textContent = isLoading ? "Memproses…" : "Masuk";
    }

    // expose untuk module
    window.__GUYUB_LOGIN__ = { showAlert, clearAlert, setLoading, emailEl, passEl };
  </script>

  <script type="module">
    const { showAlert, clearAlert, setLoading, emailEl, passEl } = window.__GUYUB_LOGIN__;

    // timeout helper biar tidak ngantung di getDoc
    const withTimeout = (p, ms = 7000, label = "timeout") =>
      Promise.race([p, new Promise((_, r) => setTimeout(() => r(new Error(label)), ms))]);

    // 1) dynamic import core (anti 404 / rewrite)
    let core;
    try {
      core = await import("/assets/js/firebase.js");
    } catch (e) {
      console.error("[GUYUB] gagal import /assets/js/firebase.js:", e);
      const msg = String(e?.message || "");
      if (msg.includes("Unexpected token") || msg.includes("<")) {
        showAlert("Core JS kena rewrite (balik HTML). Perbaiki vercel.json / rewrites.");
      } else {
        showAlert("Gagal memuat core (/assets/js/firebase.js). Cek path/404.");
      }
      setLoading(false);
      throw e;
    }

    const { initFirebase, ROUTES, routeByRole } = core;

    // 2) import auth/firestore
    const {
      onAuthStateChanged,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      sendPasswordResetEmail
    } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js");

    const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");

    const { auth, db } = initFirebase();

    function go(path) {
      window.location.replace(path);
    }

    function humanProfileError(err) {
      const msg = String(err?.message || "");
      if (msg.includes("Missing or insufficient permissions")) {
        return "Gagal baca profil (Firestore Rules menolak).";
      }
      if (msg.toLowerCase().includes("timeout")) {
        return "Timeout saat ambil profil. Cek koneksi internet.";
      }
      return "Gagal memuat profil. Cek koneksi / rules.";
    }

    async function redirectAfterLogin(uid) {
      // guard routeByRole agar selalu string valid
      const snap = await withTimeout(getDoc(doc(db, "users", uid)), 7000, "getDoc users timeout");

      if (!snap.exists()) {
        showAlert("Profil belum lengkap. Mengarah ke daftar…");
        setTimeout(() => go(ROUTES.register), 400);
        return;
      }

      const u = snap.data();
      const status = u.status || "active";
      const role = u.role || "warga";

      if (status === "suspended") {
        showAlert("Akun dinonaktifkan. Hubungi pengurus.");
        setLoading(false);
        return;
      }

      const target = routeByRole(role) || ROUTES.home;
      console.log("[GUYUB] redirect =>", target, "role:", role);
      go(target);
    }

    // kalau sudah login, auto redirect
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      try {
        setLoading(true);
        clearAlert();
        await redirectAfterLogin(user.uid);
      } catch (e) {
        console.error("[GUYUB] redirectAfterLogin error:", e);
        showAlert(humanProfileError(e));
        setLoading(false);
      }
    });

    // Email/password login
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert();

      const email = emailEl.value.trim();
      const password = passEl.value;

      try {
        setLoading(true);
        const cred = await signInWithEmailAndPassword(auth, email, password);
        await redirectAfterLogin(cred.user.uid);
      } catch (err) {
        console.error(err);
        setLoading(false);

        // bedakan error auth vs error firestore
        const code = err?.code || "";
        let msg = "Login gagal. Cek email & password.";
        if (code === "auth/user-not-found") msg = "Akun tidak ditemukan. Silakan daftar dulu.";
        if (code === "auth/wrong-password") msg = "Password salah.";
        if (code === "auth/invalid-email") msg = "Format email tidak valid.";
        if (code === "auth/too-many-requests") msg = "Terlalu banyak percobaan. Coba lagi nanti.";
        showAlert(msg);
      }
    });

    // Google login
    document.getElementById("btnGoogle").addEventListener("click", async () => {
      clearAlert();
      try {
        setLoading(true);
        const provider = new GoogleAuthProvider();
        const cred = await signInWithPopup(auth, provider);
        await redirectAfterLogin(cred.user.uid);
      } catch (err) {
        console.error(err);
        setLoading(false);
        showAlert("Login Google gagal. Pastikan pop-up tidak diblokir & Google Sign-In aktif di Firebase Auth.");
      }
    });

    // Reset password
    document.getElementById("btnReset").addEventListener("click", async () => {
      clearAlert();
      const email = emailEl.value.trim();
      if (!email) return showAlert("Isi email dulu untuk reset password.");

      try {
        setLoading(true);
        await sendPasswordResetEmail(auth, email);
        setLoading(false);
        showAlert("Link reset password sudah dikirim ke email kamu.");
      } catch (err) {
        console.error(err);
        setLoading(false);
        showAlert("Gagal kirim reset. Pastikan email benar & fitur reset aktif.");
      }
    });
  </script>
</body>
</html>
