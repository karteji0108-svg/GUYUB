<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Daftar | GUYUB</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  </style>
</head>

<body class="h-full bg-slate-950 text-slate-100 overflow-y-auto">
  <!-- Background -->
  <div class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-950 to-emerald-950/40"></div>
    <div class="absolute -top-32 -right-24 h-80 w-80 rounded-full bg-emerald-500/10 blur-3xl"></div>
    <div class="absolute -bottom-40 -left-24 h-96 w-96 rounded-full bg-sky-500/10 blur-3xl"></div>
  </div>

  <main class="min-h-full flex items-center justify-center px-6 py-10">
    <div class="w-full max-w-md">
      <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl p-7 shadow-2xl shadow-black/40">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="h-11 w-11 rounded-2xl border border-white/10 bg-white/5 flex items-center justify-center">
              <span class="font-extrabold text-lg">G</span>
            </div>
            <div>
              <div class="text-lg font-extrabold tracking-tight">Daftar Akun</div>
              <div class="text-xs text-slate-300/80">Buat akun untuk lingkungan kamu</div>
            </div>
          </div>
          <a href="/login.html" class="text-xs font-bold text-white/90 hover:underline">Masuk</a>
        </div>

        <div id="alert" class="hidden mt-5 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-xs text-slate-200"></div>

        <form id="registerForm" class="mt-6 space-y-4">
          <div>
            <label class="text-xs font-semibold text-slate-300">Nama lengkap</label>
            <input id="name" type="text" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="Nama kamu" />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Email</label>
            <input id="email" type="email" autocomplete="email" required
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="nama@email.com" />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">No. HP (opsional)</label>
            <input id="phone" type="tel" inputmode="tel"
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="+62…" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-300">RT</label>
              <input id="rt" type="text"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="03" />
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">RW</label>
              <input id="rw" type="text"
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="05" />
            </div>
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Alamat detail (opsional)</label>
            <input id="addressDetail" type="text"
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="Jl..., No..., Patokan..." />
          </div>

          <div>
            <label class="text-xs font-semibold text-slate-300">Kode Lingkungan (opsional)</label>
            <input id="neighborhoodId" type="text"
              class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
              placeholder="Contoh: NEIGH_001" />
            <p class="mt-2 text-[11px] text-slate-400">
              Kalau belum ada, kosongkan dulu. Nanti bisa diatur oleh pengurus/super admin.
            </p>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-slate-300">Password</label>
              <input id="password" type="password" autocomplete="new-password" required
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="Min 6 karakter" />
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-300">Ulangi</label>
              <input id="password2" type="password" autocomplete="new-password" required
                class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                placeholder="Ulangi" />
            </div>
          </div>

          <div class="mt-2 rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-extrabold">Ajukan sebagai Pengurus? (opsional)</div>
                <div class="mt-1 text-[11px] text-slate-300/80">
                  Jika kamu pengurus RT/PKK/KT, pilih role. Nanti perlu verifikasi admin.
                </div>
              </div>
              <label class="inline-flex items-center gap-2 text-xs font-bold">
                <input id="toggleRequest" type="checkbox" class="accent-white">
                Ajukan
              </label>
            </div>

            <div id="requestBox" class="hidden mt-4 space-y-3">
              <div>
                <label class="text-xs font-semibold text-slate-300">Pilih role yang diajukan</label>
                <select id="requestedRole"
                  class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20">
                  <option value="">— Pilih —</option>
                  <optgroup label="RT">
                    <option value="rt_ketua">RT - Ketua</option>
                    <option value="rt_sekretaris">RT - Sekretaris</option>
                    <option value="rt_bendahara">RT - Bendahara</option>
                  </optgroup>
                  <optgroup label="PKK">
                    <option value="pkk_ketua">PKK - Ketua</option>
                    <option value="pkk_sekretaris">PKK - Sekretaris</option>
                    <option value="pkk_bendahara">PKK - Bendahara</option>
                    <option value="pkk_pokja">PKK - Koordinator Pokja</option>
                  </optgroup>
                  <optgroup label="Karang Taruna">
                    <option value="kt_ketua">KT - Ketua</option>
                    <option value="kt_wakil">KT - Wakil Ketua</option>
                    <option value="kt_sekretaris">KT - Sekretaris</option>
                    <option value="kt_bendahara">KT - Bendahara</option>
                    <option value="kt_koor_sie">KT - Koordinator Sie</option>
                  </optgroup>
                </select>
              </div>

              <div>
                <label class="text-xs font-semibold text-slate-300">Catatan (opsional)</label>
                <input id="requestNote" type="text"
                  class="mt-1 w-full rounded-2xl border border-white/10 bg-slate-950/40 px-4 py-3 text-sm outline-none focus:border-white/20"
                  placeholder="Contoh: Pengurus periode 2026" />
              </div>

              <div class="text-[11px] text-slate-400">
                Setelah disetujui admin, role akunmu akan berubah otomatis.
              </div>
            </div>
          </div>

          <button id="btnSubmit" type="submit"
            class="w-full rounded-2xl bg-white px-4 py-3 text-sm font-extrabold text-slate-950 disabled:opacity-60">
            Daftar
          </button>

          <div class="text-[11px] text-slate-400 text-center">
            Dengan mendaftar, kamu setuju menggunakan GUYUB untuk kebutuhan lingkungan.
          </div>
        </form>
      </div>

      <div class="mt-4 text-center text-[11px] text-slate-500">
        Setelah daftar, kamu akan diarahkan ke aplikasi. Jika mengajukan pengurus, status akan “menunggu verifikasi”.
      </div>
    </div>
  </main>

  <script>
    const alertBox = document.getElementById("alert");
    const btnSubmit = document.getElementById("btnSubmit");
    const toggleRequest = document.getElementById("toggleRequest");
    const requestBox = document.getElementById("requestBox");

    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.classList.remove("hidden");
    }
    function clearAlert() {
      alertBox.classList.add("hidden");
      alertBox.textContent = "";
    }
    function setLoading(v) {
      btnSubmit.disabled = v;
      btnSubmit.textContent = v ? "Memproses…" : "Daftar";
    }

    toggleRequest.addEventListener("change", () => {
      requestBox.classList.toggle("hidden", !toggleRequest.checked);
    });

    // expose
    window.__GUYUB_REG__ = { showAlert, clearAlert, setLoading };
  </script>

  <!-- Register Logic -->
  <script type="module">
    import { initFirebase, ROUTES, routeByRole } from "/assets/js/firebase.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      doc,
      setDoc,
      collection,
      addDoc,
      serverTimestamp,
      query,
      where,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const { showAlert, clearAlert, setLoading } = window.__GUYUB_REG__;
    const { auth, db } = initFirebase();

    function go(path) {
      window.location.replace(path);
    }

    function cleanPhone(v) {
      const s = (v || "").trim();
      if (!s) return "";
      if (s.startsWith("08")) return "+62" + s.slice(1);
      return s;
    }

    async function isFirstSuperAdmin() {
      // cek apakah sudah ada super_admin
      const q = query(collection(db, "users"), where("role", "==", "super_admin"), limit(1));
      const snap = await getDocs(q);
      return snap.empty;
    }

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAlert();

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = cleanPhone(document.getElementById("phone").value);
      const rt = document.getElementById("rt").value.trim();
      const rw = document.getElementById("rw").value.trim();
      const addressDetail = document.getElementById("addressDetail").value.trim();
      const neighborhoodId = document.getElementById("neighborhoodId").value.trim() || null;

      const pass1 = document.getElementById("password").value;
      const pass2 = document.getElementById("password2").value;

      const isRequesting = document.getElementById("toggleRequest").checked;
      const requestedRole = document.getElementById("requestedRole").value;
      const requestNote = document.getElementById("requestNote").value.trim();

      if (!name) return showAlert("Nama wajib diisi.");
      if (!email) return showAlert("Email wajib diisi.");
      if (pass1.length < 6) return showAlert("Password minimal 6 karakter.");
      if (pass1 !== pass2) return showAlert("Password tidak sama.");
      if (isRequesting && !requestedRole) return showAlert("Pilih role yang kamu ajukan (RT/PKK/KT).");

      try {
        setLoading(true);

        // 0) cek apakah ini pendaftar pertama (belum ada super_admin)
        const firstAdmin = await isFirstSuperAdmin();

        // 1) Create auth user
        const cred = await createUserWithEmailAndPassword(auth, email, pass1);
        const uid = cred.user.uid;

        // 2) Tentukan role final saat create user doc:
        // - kalau user pertama -> super_admin (langsung aktif)
        // - kalau bukan -> warga (atau pending_verification jika mengajukan)
        const role = firstAdmin ? "super_admin" : "warga";
        const status =
          firstAdmin ? "active"
          : (isRequesting ? "pending_verification" : "active");

        const userDoc = {
          uid,
          name,
          email,
          phone: phone || "",
          neighborhoodId, // boleh null dulu
          role,
          status,
          address: { rt: rt || "", rw: rw || "", detail: addressDetail || "" },

          // audit
          verifiedBy: firstAdmin ? uid : null,
          verifiedAt: firstAdmin ? serverTimestamp() : null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        await setDoc(doc(db, "users", uid), userDoc, { merge: true });

        // 3) Jika ajukan role (HANYA jika bukan super_admin pertama)
        if (!firstAdmin && isRequesting) {
          await addDoc(collection(db, "role_requests"), {
            neighborhoodId,
            uid,
            requestedRole,
            note: requestNote || "",
            status: "pending",
            reviewedBy: null,
            reviewedAt: null,
            createdAt: serverTimestamp()
          });
        }

        // 4) Mark onboarding done
        localStorage.setItem("guyub_onboarding_done", "1");

        // 5) Redirect sesuai role
        go(routeByRole(role));

      } catch (err) {
        console.error(err);
        setLoading(false);

        let msg = "Gagal daftar. Coba lagi.";
        if (err.code === "auth/email-already-in-use") msg = "Email sudah terdaftar. Silakan login.";
        if (err.code === "auth/invalid-email") msg = "Format email tidak valid.";
        if (err.code === "auth/weak-password") msg = "Password terlalu lemah (minimal 6 karakter).";
        showAlert(msg);
      }
    });
  </script>
</body>
</html>
